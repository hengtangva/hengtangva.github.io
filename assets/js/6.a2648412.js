(window.webpackJsonp=window.webpackJsonp||[]).push([[6],{375:function(v,_,t){v.exports=t.p+"assets/img/cache.67f5540d.jpg"},376:function(v,_,t){v.exports=t.p+"assets/img/cache1.dd38f9f8.jpg"},377:function(v,_,t){v.exports=t.p+"assets/img/cache2.d1d67b6c.jpg"},378:function(v,_,t){v.exports=t.p+"assets/img/cache3.41a86296.jpg"},379:function(v,_,t){v.exports=t.p+"assets/img/cache4.e00e0f08.jpg"},380:function(v,_,t){v.exports=t.p+"assets/img/cache5.f2a009ec.jpg"},514:function(v,_,t){"use strict";t.r(_);var a=t(42),e=Object(a.a)({},(function(){var v=this,_=v.$createElement,a=v._self._c||_;return a("ContentSlotsDistributor",{attrs:{"slot-key":v.$parent.slotKey}},[a("h1",{attrs:{id:"浏览器缓存机制"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#浏览器缓存机制"}},[v._v("#")]),v._v(" 浏览器缓存机制")]),v._v(" "),a("h2",{attrs:{id:"前言"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#前言"}},[v._v("#")]),v._v(" 前言")]),v._v(" "),a("p",[v._v("这部分知识会涉及到 缓存服务器(代理服务器)，以及 http 首部的 catch-control 字段。")]),v._v(" "),a("p",[v._v("我们借了解浏览器缓存机制，也顺便复习一下，之前的这些知识。")]),v._v(" "),a("h2",{attrs:{id:"缓存的作用"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#缓存的作用"}},[v._v("#")]),v._v(" 缓存的作用")]),v._v(" "),a("p",[v._v("缓存的作用其实很容易理解。")]),v._v(" "),a("ol",[a("li",[a("p",[v._v("一方面，如果本地有缓存，就可以用本地资源，而不必请求服务器了，页面加载速度肯定要快的多。")])]),v._v(" "),a("li",[a("p",[v._v("另一方面，由于没有请求服务器，也侧面的缓解了服务器的压力。")])])]),v._v(" "),a("p",[v._v("当然，如果缓存多了，不清理的话，也可能导致浏览器卡顿。")]),v._v(" "),a("p",[v._v("具体缓存流程如下图：")]),v._v(" "),a("p",[a("img",{attrs:{src:t(375),alt:""}})]),v._v(" "),a("hr"),v._v(" "),a("p",[v._v("下面我们来介绍浏览器的两种缓存解决办法。")]),v._v(" "),a("h2",{attrs:{id:"强制缓存"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#强制缓存"}},[v._v("#")]),v._v(" 强制缓存")]),v._v(" "),a("p",[v._v("首先，我们明确一些前提，")]),v._v(" "),a("ol",[a("li",[a("p",[v._v("第一次访问时肯定是没有缓存的，")])]),v._v(" "),a("li",[a("p",[v._v("第一次请求接受到了响应后，浏览器如何知道哪些资源该缓存，哪些又不需要呢？唯一的信息就在响应头部了。")])]),v._v(" "),a("li",[a("p",[v._v("事实上，也确实是在响应头部，告诉浏览器，我这次响应的资源是否缓存，缓存多久就失效了。")])]),v._v(" "),a("li",[a("p",[v._v("而这些信息一般由两个响应头部字段控制，Cache-Control，Expires。")])])]),v._v(" "),a("hr"),v._v(" "),a("p",[v._v("所以我们先来了解这两个字段。")]),v._v(" "),a("p",[a("strong",[v._v("Cache-Control")]),a("br"),v._v("\n, 见名知意，就是控制缓存相关的。我们来看看它有哪些值。")]),v._v(" "),a("table",[a("thead",[a("tr",[a("th",[v._v("值")]),v._v(" "),a("th",[v._v("解释")])])]),v._v(" "),a("tbody",[a("tr",[a("td",[v._v("public")]),v._v(" "),a("td",[v._v("所有内容都将被缓存(客户端和代理服务器都可缓存)")])]),v._v(" "),a("tr",[a("td",[v._v("private")]),v._v(" "),a("td",[v._v("所有内容只有客户端可以缓存，默认值")])]),v._v(" "),a("tr",[a("td",[v._v("no-cache")]),v._v(" "),a("td",[v._v("客户端缓存内容，但是否使用缓存则需要经过协商缓存来验证决定(稍后会介绍)")])]),v._v(" "),a("tr",[a("td",[v._v("no-store")]),v._v(" "),a("td",[v._v("所有内容都不会被缓存")])]),v._v(" "),a("tr",[a("td",[v._v("max-age= x")]),v._v(" "),a("td",[v._v("x 秒后，缓存会失效")])])])]),v._v(" "),a("p",[v._v("代理服务器基本和 cdn 原理一样，代理服务器保存源服务器的一些内容，请求命中时，直接返回响应。")]),v._v(" "),a("p",[a("strong",[v._v("expires")])]),v._v(" "),a("p",[v._v("它是 http/1.0 实现缓存的方式，仅做了解即可，因为它与 cache-control 同时出现的时候，后者是优先考虑，存在的理由是考虑兼容。"),a("br"),v._v("\n它的值，是缓存过期的时间，但由于各国时间不同，因此不准确。")]),v._v(" "),a("hr"),v._v(" "),a("p",[v._v("通过上的描述，我们知道了缓存如何告知浏览器，那么缓存资源存在哪呢?")]),v._v(" "),a("p",[v._v("来看打开自己的博客，资源请求情况：")]),v._v(" "),a("p",[a("img",{attrs:{src:t(376),alt:""}})]),v._v(" "),a("p",[v._v("size 的部分显示的是，请求资源的大小，我们刷新一遍再看。")]),v._v(" "),a("p",[a("img",{attrs:{src:t(377),alt:""}})]),v._v(" "),a("p",[v._v("再看 size 部分，显示的是 diskcache,说明资源是从 diskcache 来的")]),v._v(" "),a("p",[v._v("再刷新一次(得间隔很短时间很刷新哦，这个很重要，因为时间过长的话，看不到下面结果)")]),v._v(" "),a("p",[a("img",{attrs:{src:t(378),alt:""}})]),v._v(" "),a("p",[v._v("再看红圈的 size 部分，显示的是 memorycache，说明资源文件是从 memorycache 来的。")]),v._v(" "),a("p",[v._v("很明显，diskcache 就是硬盘上的缓存了，一般是存储在文件中的 ，memorycache，是内存上的缓存，进程执行完就删除。")]),v._v(" "),a("p",[v._v("很 cpu 运行很像，浏览器优先考虑用 内存中的资源(因为读取块)，也就是 memorycache，没有才用外部(硬盘文件)")]),v._v(" "),a("p",[v._v("但，memorycache 保存的时间很短(因为内存空间比较小，不可能放太多东西)，一段时间后，相关进程关闭，memorycache 也就自动删除了。")]),v._v(" "),a("p",[v._v("这也解释了为什么第二次刷新为什么要间隔很短操作。")]),v._v(" "),a("h3",{attrs:{id:"缓存资源放在哪"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#缓存资源放在哪"}},[v._v("#")]),v._v(" 缓存资源放在哪？")]),v._v(" "),a("p",[v._v("memorycache 里面的东西，我们不好查看，但是 diskcache 既然是文件形式，我们就能再磁盘中找到它。")]),v._v(" "),a("p",[v._v("以 Google 浏览器为例子。")]),v._v(" "),a("p",[v._v("这部分文件存储路径如下：")]),v._v(" "),a("p",[a("strong",[v._v("C:\\Users\\username(自己的用户名)\\AppData\\Local\\Google\\Chrome\\User Data\\Default\\Cache")])]),v._v(" "),a("p",[v._v("我们打开后如下：")]),v._v(" "),a("p",[a("img",{attrs:{src:t(379),alt:""}})]),v._v(" "),a("p",[v._v("很遗憾，我们无法打开这里的文件，也看不懂它是什么。")]),v._v(" "),a("p",[v._v("这里就可以用一个工具 ChromCacheView")]),v._v(" "),a("p",[v._v("打开后，它会自动打开上面目录的 cache 文件夹，然后给我们显示的结果如下：")]),v._v(" "),a("p",[a("img",{attrs:{src:t(380),alt:""}})]),v._v(" "),a("p",[v._v("看到这里，应该就能明白存储的是什么了，是的，是 http 响应报文。")]),v._v(" "),a("p",[v._v("这便是我们的 diskcache 里的内容。")]),v._v(" "),a("p",[v._v("同样，我们也能类比出 ，memorycache 中存的也是 http 响应报文。")]),v._v(" "),a("hr"),v._v(" "),a("p",[v._v("似乎有些扯远了，我们还是回到强制缓存。")]),v._v(" "),a("p",[v._v("强制缓存就是请求时先 查找浏览器的缓存结果，再根据该结果来确定是否用该缓存结果")]),v._v(" "),a("p",[v._v("请求时一般会碰到这四种情况")]),v._v(" "),a("ol",[a("li",[a("p",[v._v("第一次请求， 没有缓存。")])]),v._v(" "),a("li",[a("p",[v._v("虽然不是第一次请求，但是之前收到的响应报文没有叫我缓存，于是得继续向服务器发请求。")])]),v._v(" "),a("li",[a("p",[v._v("之前收到的报文由明确叫我缓存，浏览器缓存了，但是查到后发现，有效时间过了(max-age),于是该缓存就没啥用了，还得重新请求。")])]),v._v(" "),a("li",[a("p",[v._v("查到浏览器的缓存了，且还在有效期，于是就不请求了，直接返回之前缓存的结果。")])])]),v._v(" "),a("hr"),v._v(" "),a("p",[v._v("在看 第三条 的时候，是不是觉得很遗憾？，我明明缓存了呀，虽然有效期过了，但说不定你服务器中的资源没有改变呢？")]),v._v(" "),a("p",[v._v("那我还是可以用这个缓存的资源，于是，浏览器就先不急着请求服务器的响应报文，先和浏览器协商一下，问一下，自己的缓存还能不能用。")]),v._v(" "),a("p",[v._v("于是也引起了我们第二种缓存——协商缓存。")]),v._v(" "),a("h2",{attrs:{id:"协商缓存"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#协商缓存"}},[v._v("#")]),v._v(" 协商缓存")]),v._v(" "),a("p",[v._v("接着上一节的结尾说，浏览器和服务器协商的方法有两种(肯定都是通过首部来协商)。")]),v._v(" "),a("h3",{attrs:{id:"last-modified-if-modified-since"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#last-modified-if-modified-since"}},[v._v("#")]),v._v(" Last-Modified/If-Modified-Since")]),v._v(" "),a("p",[v._v("Last-Modified 是响应报文的一个字段，用户告诉该报文最后修改的时间。")]),v._v(" "),a("p",[v._v("If-Modified-Since 是请求报文的一个字段，值是上一次响应报文的 Last-Modified。")]),v._v(" "),a("p",[v._v("也就是说，浏览器把 If-Modifed-Since 字段发出去后，服务器就可以和服务器上该资源最后修改的时间进行对比")]),v._v(" "),a("p",[v._v("如果时间是一样的(没有修改过)。")]),v._v(" "),a("p",[v._v("就返回  304 Not Modified")]),v._v(" "),a("p",[v._v("告诉浏览器，放心用那份缓存资源吧，还有用的，我就不重复发一份了，毕竟都一样。")]),v._v(" "),a("p",[v._v("如果，最后修改的时间大于 If-Modified-Since 的话，说明真的失效了，得重新发一份。")]),v._v(" "),a("h3",{attrs:{id:"etag-if-none-match"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#etag-if-none-match"}},[v._v("#")]),v._v(" Etag/If-None-Match")]),v._v(" "),a("p",[v._v("如果，在服务器响应的时候，给该资源一个独一无二的标签 Etag。")]),v._v(" "),a("p",[v._v("并且服务器默认规定，只要资源不更新，该资源就始终对应这个 Etag，资源更新就重新生成一个独一无二的 Etag(和之前的不同)")]),v._v(" "),a("p",[v._v("那么，请求时，就可以设置 if-none-match 字段，并把值赋为 Etag。")]),v._v(" "),a("p",[v._v("待服务器接收到请求报文后，就会根据这个 if-none-match 的值来匹配，看是否有资源的 Etag 是这个。")]),v._v(" "),a("p",[v._v("如果有，说明资源未更新，返回 304 Not Modified.")]),v._v(" "),a("p",[v._v("如果没有，说明资源更新了，在响应中返回新的资源，返回 200 OK")]),v._v(" "),a("h2",{attrs:{id:"清除缓存"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#清除缓存"}},[v._v("#")]),v._v(" 清除缓存")]),v._v(" "),a("p",[v._v("如果想清除缓存的话，")]),v._v(" "),a("ul",[a("li",[a("p",[v._v("f5 刷新网页会跳过强制缓存，但是会检查协商缓存。")])]),v._v(" "),a("li",[a("p",[v._v("ctrl+f5 刷新网页的话，直接从服务器加载资源，强制缓存和协商缓存都会跳过")])])]),v._v(" "),a("h2",{attrs:{id:"总结"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#总结"}},[v._v("#")]),v._v(" 总结")]),v._v(" "),a("p",[v._v("之前，学过，为什么 webpack 打包 js ，css 这些资源文件的时候是以一个唯一的 hash 码命名，且重新打包后，又会重新生成新的不一样的 hash 码文件名。")]),v._v(" "),a("p",[v._v("放在这里来理解一下。当服务器的资源更新时，webpack 会重新打包，生成新的 hash 文件名(所有打包后的文件)")]),v._v(" "),a("p",[v._v("带来的好处是，如果缓存的资源还在有效期，但在这期间服务器改动资源，浏览器是请求不到新的资源的。")]),v._v(" "),a("p",[v._v("通过 webpack 的打包，就能实施实时更新。")]),v._v(" "),a("p",[v._v("但是，坏处是，之前的强缓存就会全部失效，因为文件名都不同了(url 自然也不同了)，浏览器以为在请求不同资源呢。")]),v._v(" "),a("p",[v._v("带来的是，协商缓存也跟着失效，因为浏览器以为自己没有要请求资源的缓存，自然不会去关注过期。更不会去协商。")]),v._v(" "),a("p",[v._v("如果我觉得要改进的话，最好，是 webpack 打包时只重新为那些更改了文件重新生成 hash 值。")]),v._v(" "),a("p",[v._v("如果能做到这点的话，就没有必要设置过期时间了，因为一更新文件名就会改变，就会立马知道。于是协商缓存就没有必要存在了。")]),v._v(" "),a("p",[v._v("参考：https://juejin.cn/post/6844903593275817998\nhttp://cn.tipsandtricks.tech/%E5%A6%82%E4%BD%95%E4%BB%8E%E6%B5%8F%E8%A7%88%E5%99%A8%E6%9F%A5%E7%9C%8B%E7%BC%93%E5%AD%98%E7%9A%84%E9%A1%B5%E9%9D%A2%E5%92%8C%E6%96%87%E4%BB%B6")])])}),[],!1,null,null,null);_.default=e.exports}}]);