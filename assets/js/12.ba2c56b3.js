(window.webpackJsonp=window.webpackJsonp||[]).push([[12],{427:function(_,v,t){_.exports=t.p+"assets/img/tcpshakehand.1a2f4baa.jpg"},428:function(_,v,t){_.exports=t.p+"assets/img/tcpstateserver.f421c11e.jpg"},429:function(_,v,t){_.exports=t.p+"assets/img/tcpstateclient.4a723db5.jpg"},603:function(_,v,t){"use strict";t.r(v);var s=t(42),a=Object(s.a)({},(function(){var _=this,v=_.$createElement,s=_._self._c||v;return s("ContentSlotsDistributor",{attrs:{"slot-key":_.$parent.slotKey}},[s("h1",{attrs:{id:"tcp-的连接管理"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#tcp-的连接管理"}},[_._v("#")]),_._v(" TCP 的连接管理")]),_._v(" "),s("p",[_._v("ack: 代表首部的确认号字段")]),_._v(" "),s("p",[_._v("seq：代表首部中的序号字段")]),_._v(" "),s("h2",{attrs:{id:"建立连接"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#建立连接"}},[_._v("#")]),_._v(" 建立连接")]),_._v(" "),s("p",[_._v("建立连接也叫三次握手，来回要发 3 个包")]),_._v(" "),s("p",[_._v("先来看三次握手比较相详细的图：")]),_._v(" "),s("p",[s("img",{attrs:{src:t(427),alt:""}})]),_._v(" "),s("ol",[s("li",[s("p",[_._v("客户端发送一报文，不含数据。首部中， SYN = 1 (请求建立连接)，生成一随机数 client_isn, seq=client_isn")])]),_._v(" "),s("li",[s("p",[_._v("服务器接收到后，会为该 TCP 连接分配 tcp 缓存和变量。并向客户端发送允许连接报文。")])])]),_._v(" "),s("p",[_._v("该报文不包含数据。首部中，SYN = 1 (请求连接)， ACK = 1, ack = client_isn + 1，")]),_._v(" "),s("p",[_._v("生成随机数 sever_isn, seq = sever_isn，")]),_._v(" "),s("p",[_._v("表明，我收到了你发送的请求连接分组，该分组带有的初始序号是 clinet_isn ，我的初始序号是 server_isn")]),_._v(" "),s("ol",{attrs:{start:"3"}},[s("li",[_._v("客户端收到报文后，也要为该连接分配缓存和变量。并向服务器发送报文。")])]),_._v(" "),s("p",[_._v("该报文是对服务器的允许连接进确认 (ack =  serve_isn + 1), SYN = 0, ACK = 1, seq = client_isn + 1。")]),_._v(" "),s("p",[_._v("该步可以携带应用层的数据。")]),_._v(" "),s("h2",{attrs:{id:"关闭连接"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#关闭连接"}},[_._v("#")]),_._v(" 关闭连接")]),_._v(" "),s("p",[_._v("关闭连接也叫 tcp 的四次挥手")]),_._v(" "),s("p",[_._v("详情如下图：")]),_._v(" "),s("ol",[s("li",[s("p",[_._v("客户端请求断开连接，发送 tcp 包，FIN = 1, seq = random_client")])]),_._v(" "),s("li",[s("p",[_._v("服务器收到后，发送 ACK = 1, ack = random_clinet+1, seq = server_random_1")])]),_._v(" "),s("li",[s("p",[_._v("服务器接着发送 FIN = 1, seq = server_random_2")])]),_._v(" "),s("li",[s("p",[_._v("客户端接收后，发送 ACK = 1, seq = random_clinet+1, ack = sever_random_2 + 1")])]),_._v(" "),s("li",[s("p",[_._v("服务端收到后，关闭连接，释放变量和缓存")])]),_._v(" "),s("li",[s("p",[_._v("客户端等待 2MSL 后，关闭连接，释放变量和缓存")])])]),_._v(" "),s("h2",{attrs:{id:"客户端和服务器的连接状态"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#客户端和服务器的连接状态"}},[_._v("#")]),_._v(" 客户端和服务器的连接状态")]),_._v(" "),s("p",[_._v("我们假设建立连接请求和关闭请求都是又客户端发起的。")]),_._v(" "),s("p",[_._v("服务器：")]),_._v(" "),s("p",[s("img",{attrs:{src:t(428),alt:""}})]),_._v(" "),s("ol",[s("li",[s("p",[_._v("服务器一开始处于 CLOSED 状态，服务器应用程序创建一个监听 soket 后，进入 LISTEN 阶段。")])]),_._v(" "),s("li",[s("p",[_._v("接受到 客户端的 SYN 报文，发送 SYN & ACK ,进入 SYN_REVD 阶段。")])]),_._v(" "),s("li",[s("p",[_._v("接收到客户端的 ACK 报文后，进入 ESTABLISH 阶段")])]),_._v(" "),s("li",[s("p",[_._v("接受客户端的 FIN 报文后，发送 ACK 报文，进入 CLOSE_WAIT 阶段")])]),_._v(" "),s("li",[s("p",[_._v("发送 FIN 报文，进入 LAST_ACK 阶段")])]),_._v(" "),s("li",[s("p",[_._v("接受客户端的 ACK 报文，进入 CLOSED 阶段。")])])]),_._v(" "),s("p",[_._v("客户机：")]),_._v(" "),s("p",[s("img",{attrs:{src:t(429),alt:""}})]),_._v(" "),s("ol",[s("li",[s("p",[_._v("客户机一开始处于 CLOSED 阶段。在发送 SYN 报文后，处于 SYN_SENT 阶段，等待服务器的确认报文")])]),_._v(" "),s("li",[s("p",[_._v("收到服务器报文 SYN = 1 & ACK = 1 后，发送 ACK 报文，进入 ESTABLISHED 阶段。")])]),_._v(" "),s("li",[s("p",[_._v("发送 FIN 报文后，进入 FIN_WAIT_1 阶段，等待服务的确认。")])]),_._v(" "),s("li",[s("p",[_._v("收到服务器的 ACK 报文后，进入 FIN_WAIT_2 阶段，等待服务器的 FIN 报文")])]),_._v(" "),s("li",[s("p",[_._v("收到 FIN 报文后，发送 ACK 报文给服务器，进入 TIME_WAIT 阶段")])]),_._v(" "),s("li",[s("p",[_._v("等待时间过，回到 CLOSED 阶段")])])]),_._v(" "),s("h2",{attrs:{id:"特殊情况"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#特殊情况"}},[_._v("#")]),_._v(" 特殊情况")]),_._v(" "),s("h3",{attrs:{id:"客户机最后为什么要等-2msl"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#客户机最后为什么要等-2msl"}},[_._v("#")]),_._v(" 客户机最后为什么要等 2MSL")]),_._v(" "),s("p",[_._v("原因是这样的，")]),_._v(" "),s("ol",[s("li",[_._v("如果发送的 ACK 报文丢失，那么服务器在超时后，又会发送 FIN 报文，希望客户端响应。")])]),_._v(" "),s("p",[_._v("但是，假如客户端直接关闭的话，这个 FIN 报文就得不到响应，服务器就会一直重传，不能正常关闭。")]),_._v(" "),s("p",[_._v("所以，客户端要等 2 MSL .这段时间是一个报文往返的时间，如果之前的报文丢失。")]),_._v(" "),s("p",[_._v("那么经过这个时间后，服务器的重传请求会到达。这时候，客户端重新返回一个 ACK 报文，重新计时，再等待 2MSL")]),_._v(" "),s("p",[_._v("当然，如果服务器重传的报文也丢失了的话，感觉就没得办法了。")]),_._v(" "),s("p",[_._v("服务器只有在重传多次之后，才确定连接已经失效，自动关闭连接了。")]),_._v(" "),s("ol",{attrs:{start:"2"}},[s("li",[_._v("请求失效问题。")])]),_._v(" "),s("h3",{attrs:{id:"客户机服务器同时请求连接或关闭"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#客户机服务器同时请求连接或关闭"}},[_._v("#")]),_._v(" 客户机服务器同时请求连接或关闭")]),_._v(" "),s("p",[_._v("这种情况虽然少见，但是也会出现。且 tcp 只创建一个连接")]),_._v(" "),s("ul",[s("li",[_._v("连接")])]),_._v(" "),s("ol",[s("li",[s("p",[_._v("若同时请求连接。它们发送 SYN 报文后，就都进入 SYN_SENT 阶段")])]),_._v(" "),s("li",[s("p",[_._v("一旦接受到对方的 SYN 报文， 在报文中响应该 SYN ,并且 报文的 SYN 标志 还要设为 1 ，并进入 SYN_REVD 阶段")])]),_._v(" "),s("li",[s("p",[_._v("当收到对方的报文后，就进入 ESTABLISH 阶段")])])]),_._v(" "),s("p",[_._v("上述发生了 4 次握手")]),_._v(" "),s("hr"),_._v(" "),s("ul",[s("li",[_._v("关闭")])]),_._v(" "),s("p",[_._v("关闭这里没有找到好的解释，感觉一些博客解释的很牵强。暂时放这。")])])}),[],!1,null,null,null);v.default=a.exports}}]);